var UBB=function(){function f(a){this.setting=f.mix({defaultColor:"#000000",linkDefaultColor:"#006699",flashImage:"/skin/imgs/flash.png"},a);this.setting.tags=f.mix(n,this.setting.tags);this.setting.ubbTagsOrder={};this.setting.wrapUbbTags={};var h,e,d,b,c,g,a=this.setting;for(h in a.tags){e=a.tags[h];switch(e.canContains){case "*":a.ubbTagsOrder[h]=!0;break;case "":a.ubbTagsOrder[h]=!1;break;case void 0:a.ubbTagsOrder[h]=!1;break;default:c=e.canContains.split(",");g={};d=0;for(b=c.length;d<b;d++)g[c[d].toLowerCase()]=
!0;a.ubbTagsOrder[h]=g}a.wrapUbbTags[h]=e.canWrap}}var d={clone:function(a,h){h||(h=a,a=this);if(!a.isNode)return null;if(h){var e,b,c=a.clone();e=0;for(b=a.length;e<b;e++)a[e].isNode&&c.append(a[e].clone(!0));return c}return d.createNode(a.name,a.attr)},append:function(a,h){h||(h=a,a=this);if(!h)return a;if(h.parent)throw"Node "+h.name+" has a parent node!";a.push(h);return h.parent=a},getDeepestChild:function(a){for(var h;h=a[a.length-1];)a=h;return a},createNode:function(a,h){var e=[];e.isNode=
!0;e.append=d.append;e.clone=d.clone;a&&(e.name=a);h&&(e.attr=h);return e},createTextNode:function(a){var h=d.createNode("#text");h.value=a;return h}},c=/([A-Z])/g,b=/-([a-z])/g,k=/^-?\d/,m=/^-?\d+(?:px)?$/i,j=/\[(\/)?([a-zA-Z]+)/,n={},u={block:1,table:1,"table-caption":1,"table-footer-group":1,"table-header-group":1,"table-row":1,"table-row-group":1,"list-item":1},v={img:1,object:1,button:1,textarea:1,input:1,select:1},w={pre:1,"pre-wrap":1,"pre-line":1},x={pre:1,"pre-wrap":1},g={isInlineBlock:function(a,
h){var e=g.getComputedStyle(a,"display");return!!("inline-block"===e||"inline"===e&&v[h])},hasBlockBox:function(a){return!!u[g.getComputedStyle(a,"display")]},isKeepNewLine:function(a,h){return"pre"===h||"textarea"===h?2:w[g.getComputedStyle(a,"white-space")]?1:0},isKeepWhiteSpace:function(a){return!!x[g.getComputedStyle(a,"white-space")]},ubbEscape:function(a){return a.replace(/(\[|\])/g,"\\$1")},changeState:function(a,h,e){var d=a.node,b,c={1:1,2:2,3:3,5:2,6:1,7:2,8:2};if((b={"0":{1:0,2:0,3:0,4:0,
5:0,6:0,7:0,8:0},1:{1:0,2:0,3:1,4:0,7:0,8:0},2:{1:1,2:1,3:1,4:0,7:1,8:1},3:{1:1,2:1,3:1,4:0,7:1,8:1}}[a.key][h])&&d)d.suffix=(d.suffix||"")+(1==b?"\n":"\n\n");h in c&&(a.key=c[h]);a.node=e},parseNode:function(a,h,e,d,b,c){var k,i,f,j;i=c.boxStates;c=c.textStates;i=i[i.length-1];f=c[c.length-1];switch(e){case 8:return;case 3:e=a.nodeValue.replace(/\r\n/g,"\n");c=f.keepNewLine;f=f.keepWhiteSpace;c||(e=e.replace(/^\n|\n$/g,"").replace(/\n/g," "));f||(e=e.replace(/^[\u0020\u200B\u200A\u3000\u2000]*|[\u0020\u200B\u200A\u3000\u2000]*$/g,
"").replace(/[\u0020\u200B\u200A\u3000\u2000]{2,}/g," "));e=g.ubbEscape(e);if(""===e)return;j=2===c&&"\n"===e.slice(0,1)&&0===i.key;c=c&&1<e.length&&"\n"===e.slice(-1);f?"\n"===e?(b.text="",j?g.changeState(i,6,b):g.changeState(i,8,b)):j&&c?(b.text=e.slice(1,-1),g.changeState(i,5,b)):j?(b.text=e.slice(1),g.changeState(i,6,b)):c?(b.text=e.slice(0,-1),g.changeState(i,7,b)):(b.text=e,g.changeState(i,1,b)):(b.text=e,g.changeState(i,1,b));break;case 1:"br"===h?g.changeState(i,2,b):b.hasBlockBox?0<a.offsetHeight?
g.changeState(i,3,b):g.changeState(i,2,b):g.changeState(i,g.isInlineBlock(a,h)?1:4,b)}for(k in d.tags)i=d.tags[k],i.parseHTML&&i.parseHTML(h,a,b,d);return b},treeToUbb:function(a){var b,e,d,c=[a.prefix||""];a.text&&c.push(a.text);b=0;for(e=a.length;b<e;b++)d=a[b],c.push(g.treeToUbb(d));c.push(a.suffix||"");return c.join("")},canContains:function(a,b,e){a=e[a.name];return"boolean"===typeof a?a:a[b.name]},pushOpenUbbTag:function(a,b,e){for(var c;!a.isRoot&&!g.canContains(a,b,e);)c=c?a.clone().append(c):
a.clone(),a=a.parent;a.append(b);return c&&g.canContains(b,c,e)?(b.append(c),d.getDeepestChild(c)):b},pushCloseUbbTag:function(a,b){for(var e;!a.isRoot&&a.name!==b;)e=e?a.clone().append(e):a.clone(),a=a.parent;if(a.isRoot)return a;a=a.parent;a.append(e);return e?d.getDeepestChild(e):a},pushLineUbbTag:function(a,b){for(var e;!a.isRoot&&!b[a.name];)e=e?a.clone().append(e):a.clone(),a=a.parent;a.append(d.createTextNode("\n"));a.append(e);return e?d.getDeepestChild(e):a},htmlEncode:function(a){a&&(a=
a.replace(/&/igm,"&amp;"),a=a.replace(/</igm,"&lt;"),a=a.replace(/>/igm,"&gt;"),a=a.replace(/\"/igm,"&quot;"));return a},scanUbbText:function(a,b,e){e&&(a=g.htmlEncode(a));var a=a.replace(/\r\n/g,"\n"),c,f,k,m,e=b.ubbTagsOrder,b=b.wrapUbbTags,i=0,n=0,p=a.length,l="",q=d.createNode(),o=q;for(q.isRoot=!0;n<p;n++)switch(c=a.charAt(n),c){case "\\":i=1;break;case "[":1===i?(l+="[",i=0):(l&&o.append(d.createTextNode(l)),l="[");break;case "]":1===i?(l+="]",i=0):((f=j.exec(l))&&f[2]&&(k=f[2].toLowerCase())in
e?(c=!!f[1],c||(m=l.slice(f[2].length+(f[1]?2:1)),m=d.createNode(k,m)),o=c?g.pushCloseUbbTag(o,k):g.pushOpenUbbTag(o,m,e)):o.append(d.createTextNode(l+"]")),l="");break;case "\n":1===i&&(i=0);l&&(o.append(d.createTextNode(l)),l="");o=g.pushLineUbbTag(o,b);break;default:1===i&&(i=0),l+=c}l&&o.append(d.createTextNode(l));return q},parseUbbNode:function(a,b,e,c){var d=e.tags,g;if("#text"===a.name){if("\n"===a.value)return c.nobr?(c.nobr=!1,""):"<br/>";c.nobr=!1;return a.value.replace(/\s/g,"&nbsp;")}if((g=
d[a.name])&&g.parseUBB)return g.isBlock&&(c.nobr=!0),g.parseUBB(a,b,e)},fixUbbNode:function(a,b){return"#text"===a.name?g.ubbEscape(a.value):"["+a.name+(a.attr||"")+"]"+b+"[/"+a.name+"]"}},r=function(a,b,c,f){var k,j,m,i=d.createNode(),n=a.nodeType,p=a.nodeName.toLowerCase(),l=a.childNodes;c||(c={boxStates:[],textStates:[]});1===n&&(g.hasBlockBox(a)&&(c.boxStates.push({key:0,node:null}),i.hasBlockBox=!0),c.textStates.push({keepNewLine:g.isKeepNewLine(a,p),keepWhiteSpace:g.isKeepNewLine(a)}));k=0;
for(j=l.length;k<j;k++)(m=r(l[k],b,c,!0))&&i.append(m);1===n&&c.textStates.pop();i.hasBlockBox&&c.boxStates.pop();return f?g.parseNode(a,p,n,b,i,c):g.treeToUbb(i)},s=function(a,b,c){var d,f,k=[],c=c||{};if(a.isNode){d=0;for(f=a.length;d<f;d++)k.push(s(a[d],b,c))}return a.isRoot?k.join(""):g.parseUbbNode(a,k.join(""),b,c)},t=function(a,b,c){var d,f,k=[],c=c||{};if(a.isNode){d=0;for(f=a.length;d<f;d++)k.push(t(a[d],b,c))}return a.isRoot?k.join(""):g.fixUbbNode(a,k.join(""),b,c)};g.getComputedStyle=
document.defaultView&&document.defaultView.getComputedStyle?function(a,b){var d,g;if(d=a.ownerDocument.defaultView)return b=b.replace(c,"-$1").toLowerCase(),(d=d.getComputedStyle(a,null))&&(g=d.getPropertyValue(b)),g}:function(a,c){var c=c.replace(b,function(a){return a.charAt(1).toUpperCase()}),d,g,f=a.currentStyle&&a.currentStyle[c],j=a.style;!m.test(f)&&k.test(f)&&(d=j.left,g=a.runtimeStyle.left,a.runtimeStyle.left=a.currentStyle.left,j.left="fontSize"===c?"1em":f||0,f=j.pixelLeft+"px",j.left=
d,a.runtimeStyle.left=g);return""===f?"auto":f.toString()};f.extend=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])};f.addTags=function(a){f.extend(n,a)};f.mix=function(a,b){var c={};f.extend(c,a);f.extend(c,b);return c};f.Util=g;f.prototype.HTMLtoUBB=function(a){return this.fixUBB(r(a,this.setting))};f.prototype.UBBtoHTML=function(a){return s(g.scanUbbText(a,this.setting,!0),this.setting)};f.prototype.fixUBB=function(a){return t(g.scanUbbText(a,this.setting),this.setting)};return f}();
(function(){UBB.extend(UBB.Util,{isBold:function(d){var c=parseInt(d,10);return isNaN(c)?/^(bold|bolder)$/.test(d):400<c},isItalic:function(d){return/^(italic|oblique)$/.test(d)},RGBtoHEX:function(d){var c="",b;if(b=/([0-9]+)[, ]+([0-9]+)[, ]+([0-9]+)/.exec(d)){for(d=1;d<b.length;d++)c+=("0"+parseInt(b[d],10).toString(16)).slice(-2);c="#"+c}else if(4===d.length){b=d.split("").slice(1);c="#";for(d=0;3>d;d++)c+=b[d]+b[d]}else c=d;return c}});var f=UBB.Util;UBB.addTags({bold:{parseHTML:function(d,c,
b){"#text"===d&&f.isBold(f.getComputedStyle(c.parentNode,"font-weight"))&&(b.prefix="[bold]"+(b.prefix||""),b.suffix=(b.suffix||"")+"[/bold]")},parseUBB:function(d,c){return"<b>"+c+"</b>"},canContains:"bold,italic,color,url,image",canWrap:0,isBlock:0,noAttr:1},italic:{parseHTML:function(d,c,b){"#text"===d&&f.isItalic(f.getComputedStyle(c.parentNode,"font-style"))&&(b.prefix="[italic]"+(b.prefix||""),b.suffix=(b.suffix||"")+"[/italic]")},parseUBB:function(d,c){return"<i>"+c+"</i>"},canContains:"bold,italic,color,url,image",
canWrap:0,isBlock:0,noAttr:1},color:{parseHTML:function(d,c,b,k){if("#text"===d&&(c=c.parentNode,(d=f.RGBtoHEX(f.getComputedStyle(c,"color")))&&d!==k.defaultColor&&!("a"===c.nodeName.toLowerCase()&&d===k.linkDefaultColor)))b.prefix="[color="+d+"]"+(b.prefix||""),b.suffix=(b.suffix||"")+"[/color]"},parseUBB:function(d,c){return'<span style="color:'+(d.attr?d.attr.slice(1):"")+';">'+c+"</span>"},canContains:"bold,italic,color,url,image",canWrap:0,isBlock:0,noAttr:0},url:{parseHTML:function(d,c,b){"a"===
d&&(b.prefix="[url href="+c.getAttribute("href")+"]"+(b.prefix||""),b.suffix=(b.suffix||"")+"[/url]")},parseUBB:function(d,c){var b,f,m,j=d.attr?d.attr.replace(/^\ href\=/,""):"";if(!d.attr){b=0;for(m=d.length;b<m;b++)f=d[b],"#text"===f.name&&(j+=f.value)}return'<a href="'+j+'">'+c+"</a>"},canContains:"bold,italic,color,url,image",canWrap:0,isBlock:0,noAttr:0},image:{parseHTML:function(d,c,b){"img"===d&&!c.getAttribute("data-src")&&(b.prefix="[image]"+c.getAttribute("src")+"[/image]"+(b.prefix||""))},
parseUBB:function(d,c){return c?'<img src="'+c+'"/>':""},canWrap:0,isBlock:0,noAttr:1},video:{parseHTML:function(d,c,b){var f;if("img"===d&&(f=c.getAttribute("data-src")))b.prefix="[video]"+f+"[/video]"+(b.prefix||"")},parseUBB:function(d,c,b){return c?'<img class="gui-ubb-flash" data-src="'+c+'" src="'+b.flashImage+'" width="480" height="400"/>':""},canWrap:0,isBlock:0,noAttr:1},flash:{parseUBB:function(d,c,b){return c?'<img class="gui-ubb-flash" data-src="'+c+'" src="'+b.flashImage+'" width="480" height="400"/>':
""},canWrap:0,isBlock:0,noAttr:1},blockquote:{parseHTML:function(d,c,b){"blockquote"===d&&(b.prefix="[blockquote]"+(b.prefix||""),b.suffix=(b.suffix||"")+"[/blockquote]")},parseUBB:function(d,c){return"<blockquote>"+c+"</blockquote>"},canContains:"*",canWrap:1,isBlock:1,noAttr:1},ul:{parseHTML:function(d,c,b){"ul"===d&&(b.prefix="[ul]\n"+(b.prefix||""),b.suffix=(b.suffix||"")+"\n[/ul]")},parseUBB:function(d,c){for(var b=0,f=c.split("<br/>"),m=f[0]?0:1,j=f[f.length-1]?0:-1,n=[],j=j+f.length;m<j;b++,
m++)n[b]=f[m];return"<ul><li>"+n.join("</li><li>")+"</li></ul>"},canContains:"*",canWrap:1,isBlock:1,noAttr:1},ol:{parseHTML:function(d,c,b){"ol"===d&&(b.prefix="[ol]\n"+(b.prefix||""),b.suffix=(b.suffix||"")+"\n[/ol]")},parseUBB:function(d,c){for(var b=0,f=c.split("<br/>"),m=f[0]?0:1,j=f[f.length-1]?0:-1,n=[],j=j+f.length;m<j;b++,m++)n[b]=f[m];return"<ol><li>"+n.join("</li><li>")+"</li></ol>"},canContains:"*",canWrap:1,isBlock:1,noAttr:1},ref:{parseHTML:function(d,c,b){"div"===d&&"gui-ubb-ref"===
c.className&&(b.prefix="[ref]"+(b.prefix||""),b.suffix=(b.suffix||"")+"[/ref]")},parseUBB:function(d,c){return'<div class="gui-ubb-ref">'+c+"</div>"},canWrap:0,isBlock:1,noAttr:1}})})();
